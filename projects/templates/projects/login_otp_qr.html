{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP & QR Authentication - IT-312 Projects</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 500;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .project-title {
            color: white;
            font-size: 3rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .project-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2rem;
            margin-bottom: 30px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .demo-section {
            margin-bottom: 40px;
        }

        .demo-title {
            font-size: 2rem;
            color: #150546;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-steps {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 40px;
            align-items: start;
        }

        .auth-steps.three-steps {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
        }

        .auth-steps.three-steps .step-card:nth-child(3) {
            grid-column: 1 / -1;
        }

        @media (max-width: 768px) {
            .auth-steps {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .auth-steps.three-steps .step-card:nth-child(3) {
                grid-column: 1;
            }
        }

        .step-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
        }

        .step-card.active {
            border-color: #4facfe;
            background: #f0f9ff;
            transform: scale(1.02);
        }

        .step-card.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .step-number {
            position: absolute;
            top: -15px;
            left: 20px;
            background: #4facfe;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .step-number.completed {
            background: #10b981;
        }

        .step-title {
            font-size: 1.3rem;
            color: #2d3748;
            margin-bottom: 15px;
            font-weight: 600;
            margin-top: 10px;
        }

        .step-description {
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            margin: 20px 0;
        }

        .qr-code {
            margin: 20px auto;
            padding: 15px;
            background: white;
            border-radius: 8px;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .qr-instructions {
            background: #eff6ff;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .qr-instructions h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .qr-instructions ol {
            color: #1e3a8a;
            margin-left: 20px;
            line-height: 1.6;
        }

        .otp-input {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            font-weight: bold;
            max-width: 200px;
            margin: 0 auto;
        }

        .login-status {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
        }

        .login-status.success {
            background: #f0fdf4;
            border-color: #10b981;
        }

        .login-status.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .joke-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .joke-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .joke-content {
            font-size: 1.2rem;
            line-height: 1.6;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .joke-qr-container {
            margin-top: 20px;
        }

        .message-area {
            margin: 20px 0;
        }

        .success-message {
            background: #c6f6d5;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #38a169;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e53e3e;
        }

        .info-message {
            background: #bee3f8;
            color: #2a4365;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3182ce;
        }

        .tech-details {
            margin-top: 40px;
            padding-top: 40px;
            border-top: 2px solid #e2e8f0;
        }

        .tech-title {
            font-size: 1.8rem;
            color: #150546;
            margin-bottom: 20px;
        }

        .tech-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .tech-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #4facfe;
        }

        .tech-item h4 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .tech-item p {
            color: #4a5568;
            line-height: 1.6;
        }

        .code-section {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .code-title {
            color: #4facfe;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .code {
            font-family: 'Courier New', monospace;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Mobile Responsive Styles - Add after line 326 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            /* Header adjustments */
            .back-btn {
                position: static;
                top: 10px;
                left: 10px;
                padding: 8px 15px;
                font-size: 0.9rem;
                z-index: 1000;
            }

            .header {
                margin-bottom: 25px;
                padding-top: 50px;
            }

            .project-title {
                font-size: 2rem;
                margin-bottom: 10px;
            }

            .project-subtitle {
                font-size: 1rem;
                padding: 0 10px;
            }

            /* Main card adjustments */
            .main-card {
                padding: 20px;
                margin-bottom: 20px;
            }

            .demo-title {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }

            /* Auth steps - Mobile layout */
            .auth-steps {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .auth-steps.three-steps .step-card:nth-child(3) {
                grid-column: 1 !important;
                display: block !important;
                grid-template-columns: none !important;
            }

            /* Step cards mobile */
            .step-card {
                padding: 20px;
                margin-bottom: 20px;
            }

            .step-number {
                top: -12px;
                left: 15px;
                width: 25px;
                height: 25px;
                font-size: 0.8rem;
            }

            .step-title {
                font-size: 1.1rem;
                margin-bottom: 10px;
                margin-top: 8px;
            }

            .step-description {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }

            /* Form elements mobile */
            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }

            .form-control {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .otp-input {
                font-size: 1.2rem;
                letter-spacing: 0.3rem;
                max-width: 180px;
            }

            /* Buttons mobile */
            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
                width: 100%;
                margin-bottom: 10px;
            }

            /* QR Container mobile */
            .qr-container {
                padding: 15px;
                margin: 15px 0;
            }

            .qr-code {
                margin: 15px auto;
                padding: 10px;
            }

            .qr-code canvas {
                width: 150px !important;
                height: 150px !important;
            }

            /* QR Instructions mobile */
            .qr-instructions {
                padding: 15px;
                margin: 15px 0;
            }

            .qr-instructions h4 {
                font-size: 1rem;
                margin-bottom: 8px;
            }

            .qr-instructions ol {
                font-size: 0.9rem;
                margin-left: 15px;
            }

            /* Login status mobile */
            .login-status {
                padding: 20px;
                margin: 15px 0;
            }

            .status-icon {
                font-size: 2rem;
                margin-bottom: 10px;
            }

            .login-status h3 {
                font-size: 1.2rem;
                margin-bottom: 8px;
            }

            .login-status p {
                font-size: 0.9rem;
            }

            /* Joke section mobile */
            .joke-section {
                padding: 20px;
                margin: 20px 0;
            }

            .joke-title {
                font-size: 1.2rem;
                margin-bottom: 15px;
            }

            .joke-content {
                font-size: 1rem;
                padding: 15px;
                margin: 15px 0;
                min-height: 60px;
            }

            .joke-qr-container h4 {
                font-size: 1rem;
                margin-bottom: 10px;
            }

            .joke-qr-container p {
                font-size: 0.8rem;
            }

            /* Tech details mobile */
            .tech-details {
                margin-top: 30px;
                padding-top: 30px;
            }

            .tech-title {
                font-size: 1.4rem;
                margin-bottom: 15px;
            }

            .tech-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }

            .tech-item {
                padding: 15px;
            }

            .tech-item h4 {
                font-size: 1rem;
                margin-bottom: 8px;
            }

            .tech-item p {
                font-size: 0.9rem;
            }

            /* Code section mobile */
            .code-section {
                padding: 15px;
                margin: 15px 0;
                font-size: 0.8rem;
            }

            .code-title {
                font-size: 0.9rem;
                margin-bottom: 10px;
            }

            /* Messages mobile */
            .message-area {
                margin: 15px 0;
            }

            .success-message,
            .error-message,
            .info-message {
                padding: 12px;
                font-size: 0.9rem;
            }

            /* Reset button mobile */
            .demo-section>div:last-child {
                margin-top: 20px;
            }
        }

        @media (max-width: 480px) {

            /* Extra small mobile adjustments */
            .container {
                padding: 0 10px;
            }

            .main-card {
                padding: 15px;
                border-radius: 15px;
            }

            .project-title {
                font-size: 1.7rem;
                line-height: 1.2;
            }

            .project-subtitle {
                font-size: 0.9rem;
                padding: 0 5px;
            }

            .demo-title {
                font-size: 1.3rem;
            }

            .step-card {
                padding: 15px;
            }

            .step-title {
                font-size: 1rem;
            }

            .step-description {
                font-size: 0.85rem;
            }

            .form-control {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .otp-input {
                font-size: 1.1rem;
                letter-spacing: 0.2rem;
                max-width: 160px;
            }

            .btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }

            .qr-code canvas {
                width: 120px !important;
                height: 120px !important;
            }

            .joke-content {
                font-size: 0.9rem;
                padding: 12px;
            }

            .back-btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            /* Make secret key text smaller and scrollable */
            #secretKey {
                font-size: 0.7rem;
                word-break: break-all;
                display: block;
                background: rgba(0, 0, 0, 0.1);
                padding: 5px;
                border-radius: 4px;
                margin-top: 5px;
            }

            /* Adjust QR instructions for small screens */
            .qr-instructions ol {
                font-size: 0.8rem;
                margin-left: 10px;
                padding-right: 5px;
            }

            .qr-instructions ol li {
                margin-bottom: 8px;
                line-height: 1.4;
            }
        }

        /* Fix for step 3 login layout on mobile */
        @media (max-width: 768px) {
            #step3 {
                display: block !important;
                grid-template-columns: none !important;
                gap: 20px !important;
            }

            #step3>div:first-child {
                margin-bottom: 20px;
            }

            #step3 .joke-section {
                margin: 20px 0 0 0 !important;
            }
        }

        /* Landscape mobile adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                margin-bottom: 20px;
                padding-top: 40px;
            }

            .project-title {
                font-size: 1.8rem;
            }

            .main-card {
                padding: 20px;
            }

            .step-card {
                padding: 18px;
            }
        }

        /* Touch-friendly improvements */
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                /* Minimum touch target size */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .form-control {
                min-height: 44px;
            }

            /* Improve readability of code elements on mobile */
            code {
                word-break: break-all;
                font-size: 0.8rem;
            }

            /* Better spacing for mobile */
            .qr-container p {
                margin: 8px 0;
                line-height: 1.4;
            }

            /* Improve joke content readability */
            .joke-content p {
                line-height: 1.5;
                word-wrap: break-word;
            }
        }
    </style>
</head>

<body>
    <a href="{% url 'home' %}" class="back-btn">‚Üê Back to Dashboard</a>

    <div class="container">
        <div class="header">
            <h1 class="project-title">üîê OTP & QR Authentication</h1>
            <p class="project-subtitle">Secure authentication system using Google Authenticator with joke API
                integration</p>
        </div>

        <div class="main-card">
            <!-- Demo Section -->
            <div class="demo-section">
                <h2 class="demo-title">üîí Two-Factor Authentication Demo</h2>

                <!-- Authentication Steps -->
                <div class="auth-steps three-steps">
                    <!-- Step 1: User Registration -->
                    <div class="step-card active" id="step1">
                        <div class="step-number" id="stepNum1">1</div>
                        <h3 class="step-title">üë§ User Registration</h3>
                        <p class="step-description">Register a new user account with username, password, and email for
                            2FA setup.</p>

                        <div class="form-group">
                            <label for="username">Username:</label>
                            <input type="text" id="username" class="form-control"
                                placeholder="Enter username (min 6 chars)" minlength="6">
                        </div>

                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" class="form-control" placeholder="your.email@example.com">
                        </div>

                        <div class="form-group">
                            <label for="password">Password:</label>
                            <input type="password" id="password" class="form-control"
                                placeholder="Enter secure password (min 8 chars)" minlength="8">
                        </div>

                        <button class="btn btn-primary" onclick="registerUser()">üìù Register User</button>
                        <div class="message-area" id="registerMessage"></div>
                    </div>

                    <!-- Step 2: QR Code Generation -->
                    <div class="step-card" id="step2">
                        <div class="step-number" id="stepNum2">2</div>
                        <h3 class="step-title">üì± QR Code Setup</h3>
                        <p class="step-description">Scan the QR code with Google Authenticator to register your account.
                        </p>

                        <div class="qr-container" id="qrContainer" style="display: none;">
                            <h4>Scan with Google Authenticator</h4>
                            <div class="qr-code">
                                <canvas id="qrCanvas" width="200" height="200"></canvas>
                            </div>
                            <p><strong>Account:</strong> <span id="accountInfo"></span></p>
                            <p><strong>Secret Key:</strong> <code id="secretKey"></code></p>
                        </div>

                        <div class="qr-instructions">
                            <h4>üì≤ Setup Instructions:</h4>
                            <ol>
                                <li>Install Google Authenticator on your mobile device</li>
                                <li>Open the app and tap "+" to add account</li>
                                <li>Choose "Scan QR Code" option</li>
                                <li>Scan the QR code above</li>
                                <li>Your account will be added to the app</li>
                            </ol>
                        </div>

                        <button class="btn btn-success" onclick="confirmQRSetup()" id="confirmQRBtn" disabled>‚úÖ I've
                            Scanned the QR Code</button>
                    </div>

                    <!-- Step 3: OTP Login - Now spans full width -->
                    <div class="step-card" id="step3" style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <!-- Login Form -->
                        <div>
                            <div class="step-number" id="stepNum3">3</div>
                            <h3 class="step-title">üîë OTP Login</h3>
                            <p class="step-description">Enter your username, password, and the 6-digit OTP from Google
                                Authenticator.</p>

                            <div class="form-group">
                                <label for="loginUsername">Username:</label>
                                <input type="text" id="loginUsername" class="form-control"
                                    placeholder="Enter your username">
                            </div>

                            <div class="form-group">
                                <label for="loginPassword">Password:</label>
                                <input type="password" id="loginPassword" class="form-control"
                                    placeholder="Enter your password">
                            </div>

                            <div class="form-group">
                                <label for="otpCode">6-Digit OTP Code:</label>
                                <input type="text" id="otpCode" class="form-control otp-input" placeholder="000000"
                                    maxlength="6" pattern="[0-9]{6}">
                                <small style="color: #718096; margin-top: 5px; display: block;">Get this code from
                                    Google
                                    Authenticator app</small>
                            </div>

                            <button class="btn btn-primary" onclick="loginWithOTP()" id="loginBtn" disabled>üîê Login
                                with
                                OTP</button>

                            <div class="login-status" id="loginStatus" style="display: none;">
                                <div class="status-icon" id="statusIcon">‚è≥</div>
                                <h3 id="statusTitle">Verifying...</h3>
                                <p id="statusMessage">Please wait while we verify your credentials...</p>
                            </div>
                        </div>

                        <!-- Joke QR Section - Right beside login -->
                        <div class="joke-section" id="jokeSection" style="display: none; margin: 0;">
                            <h3 class="joke-title">üéâ Login Successful!</h3>
                            <div class="joke-content" id="jokeContent">
                                Loading QR code...
                            </div>
                            <button class="btn btn-secondary" onclick="getNewJoke()" style="margin: 15px;">üé≤ Simulate
                                QR Scan
                            </button>

                            <div class="joke-qr-container">
                                <h4>üì± API QR Code:</h4>
                                <p style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">Scan to call joke API
                                    directly!</p>
                                <div class="qr-code">
                                    <canvas id="jokeQRCanvas" width="200" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Demo Reset -->
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="resetDemo()">üîÑ Reset Demo</button>
                </div>
            </div>

            <!-- Technical Details -->
            <!-- <div class="tech-details">
                <h3 class="tech-title">üîß Technical Implementation</h3>

                <div class="tech-grid">
                    <div class="tech-item">
                        <h4>Google Authenticator</h4>
                        <p>Implements TOTP (Time-based One-Time Password) algorithm for secure 2FA authentication.</p>
                    </div>

                    <div class="tech-item">
                        <h4>QR Code Generation</h4>
                        <p>Creates QR codes for Authenticator setup and joke sharing using QRious library.</p>
                    </div>

                    <div class="tech-item">
                        <h4>Joke API Integration</h4>
                        <p>Fetches random jokes from external APIs after successful authentication.</p>
                    </div>

                    <div class="tech-item">
                        <h4>Security Features</h4>
                        <p>Secure user registration, password validation, and multi-factor authentication.</p>
                    </div>
                </div>


            </div> -->
        </div>
    </div>

    <!-- Include QR Code library -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

    <script>
        let currentStep = 1;
        let registeredUser = null;
        let userSecret = null;

        function registerUser() {
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            // Validation
            if (!username || username.length < 6) {
                showMessage('registerMessage', 'Username must be at least 6 characters', 'error');
                return;
            }

            if (!email || !isValidEmail(email)) {
                showMessage('registerMessage', 'Please enter a valid email address', 'error');
                return;
            }

            if (!password || password.length < 8) {
                showMessage('registerMessage', 'Password must be at least 8 characters', 'error');
                return;
            }

            // Simulate user registration
            registeredUser = { username, email, password };
            userSecret = generateSecret();

            showMessage('registerMessage', 'User registered successfully! Proceed to QR setup.', 'success');

            // Move to step 2
            completeStep(1);
            activateStep(2);

            // Generate QR code
            generateQRCode(username, email, userSecret);
        }

        function generateSecret() {
            // Generate a proper base32 secret (32 characters)
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        function generateQRCode(username, email, secret) {
            const issuer = 'IT-312 OTP Demo';
            const otpauth = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(email)}?secret=${secret}&issuer=${encodeURIComponent(issuer)}`;

            const qr = new QRious({
                element: document.getElementById('qrCanvas'),
                value: otpauth,
                size: 200,
                background: 'white',
                foreground: '#4facfe'
            });

            document.getElementById('accountInfo').textContent = email;
            document.getElementById('secretKey').textContent = secret;
            document.getElementById('qrContainer').style.display = 'block';
            document.getElementById('confirmQRBtn').disabled = false;
        }

        function confirmQRSetup() {
            showMessage('registerMessage', 'QR Code setup confirmed! You can now login with OTP.', 'success');

            // Pre-fill login form
            document.getElementById('loginUsername').value = registeredUser.username;
            document.getElementById('loginPassword').value = registeredUser.password;

            // Move to step 3
            completeStep(2);
            activateStep(3);

            // ENABLE THE LOGIN BUTTON
            document.getElementById('loginBtn').disabled = false;
        }

        // SIMPLIFIED OTP VERIFICATION - Works with real Google Authenticator
        function base32Decode(base32) {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = 0;
            let value = 0;
            let output = [];

            for (let i = 0; i < base32.length; i++) {
                const char = base32.charAt(i).toUpperCase();
                const index = alphabet.indexOf(char);

                if (index === -1) continue;

                value = (value << 5) | index;
                bits += 5;

                if (bits >= 8) {
                    output.push((value >>> (bits - 8)) & 255);
                    bits -= 8;
                }
            }

            return new Uint8Array(output);
        }

        // Generate HMAC-SHA1 (simplified for demo)
        async function generateHOTP(secret, counter) {
            const key = base32Decode(secret);

            // Convert counter to 8-byte buffer
            const buffer = new ArrayBuffer(8);
            const view = new DataView(buffer);
            view.setUint32(4, counter, false);

            // Import key for HMAC
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                key,
                { name: 'HMAC', hash: 'SHA-1' },
                false,
                ['sign']
            );

            // Generate HMAC
            const signature = await crypto.subtle.sign('HMAC', cryptoKey, buffer);
            const hashArray = new Uint8Array(signature);

            // Dynamic truncation
            const offset = hashArray[hashArray.length - 1] & 0x0f;
            const code = (
                ((hashArray[offset] & 0x7f) << 24) |
                ((hashArray[offset + 1] & 0xff) << 16) |
                ((hashArray[offset + 2] & 0xff) << 8) |
                (hashArray[offset + 3] & 0xff)
            ) % 1000000;

            return code.toString().padStart(6, '0');
        }

        // Generate TOTP from current time
        async function generateTOTP(secret, window = 0) {
            const timeStep = Math.floor(Date.now() / 1000 / 30) + window;
            return await generateHOTP(secret, timeStep);
        }

        // Verify OTP with time window tolerance
        async function verifyOTP(secret, inputOTP) {
            // Check current window and adjacent windows (¬±1 for clock drift tolerance)
            for (let window = -1; window <= 1; window++) {
                try {
                    const expectedOTP = await generateTOTP(secret, window);
                    if (expectedOTP === inputOTP) {
                        return true;
                    }
                } catch (error) {
                    console.error('OTP generation error:', error);
                }
            }
            return false;
        }

        // FIXED LOGIN FUNCTION - Shows only QR code after login
        async function loginWithOTP() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const otpCode = document.getElementById('otpCode').value.trim();

            const loginStatus = document.getElementById('loginStatus');
            const statusIcon = document.getElementById('statusIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');

            // Show verifying status
            loginStatus.style.display = 'block';
            loginStatus.className = 'login-status';
            statusIcon.textContent = '‚è≥';
            statusTitle.textContent = 'Verifying...';
            statusMessage.textContent = 'Please wait while we verify your credentials...';

            // Validation
            if (!username || !password || !otpCode) {
                setTimeout(() => {
                    loginStatus.className = 'login-status error';
                    statusIcon.textContent = '‚ùå';
                    statusTitle.textContent = 'Login Failed';
                    statusMessage.textContent = 'Please fill in all fields';
                }, 1000);
                return;
            }

            if (otpCode.length !== 6 || !/^\d{6}$/.test(otpCode)) {
                setTimeout(() => {
                    loginStatus.className = 'login-status error';
                    statusIcon.textContent = '‚ùå';
                    statusTitle.textContent = 'Invalid OTP';
                    statusMessage.textContent = 'OTP must be exactly 6 digits';
                }, 1000);
                return;
            }

            // Check if user is registered
            if (!registeredUser) {
                setTimeout(() => {
                    loginStatus.className = 'login-status error';
                    statusIcon.textContent = '‚ùå';
                    statusTitle.textContent = 'Login Failed';
                    statusMessage.textContent = 'Please register first and complete QR setup';
                }, 1000);
                return;
            }

            try {
                // Verify username and password first
                if (username !== registeredUser.username || password !== registeredUser.password) {
                    setTimeout(() => {
                        loginStatus.className = 'login-status error';
                        statusIcon.textContent = '‚ùå';
                        statusTitle.textContent = 'Login Failed';
                        statusMessage.textContent = 'Invalid username or password';
                    }, 1500);
                    return;
                }

                // VERIFY THE ACTUAL OTP FROM GOOGLE AUTHENTICATOR
                const isValidOTP = await verifyOTP(userSecret, otpCode);

                setTimeout(() => {
                    if (isValidOTP) {
                        // SUCCESS - OTP is valid!
                        loginStatus.className = 'login-status success';
                        statusIcon.textContent = '‚úÖ';
                        statusTitle.textContent = 'Login Successful!';
                        statusMessage.textContent = 'OTP verified! Generating Joke API QR Code...';

                        completeStep(3);

                        // Show ONLY QR code section (no joke yet)
                        setTimeout(() => {
                            document.getElementById('jokeSection').style.display = 'block';
                            showJokeAPIQRCode(); // Show QR code that will fetch joke when scanned
                        }, 1500);

                    } else {
                        // FAILED - OTP is invalid
                        loginStatus.className = 'login-status error';
                        statusIcon.textContent = '‚ùå';
                        statusTitle.textContent = 'OTP Verification Failed';
                        statusMessage.textContent = 'The OTP code is invalid or expired. Please try again with the current code from Google Authenticator.';
                    }
                }, 2000);

            } catch (error) {
                console.error('OTP Verification Error:', error);
                setTimeout(() => {
                    loginStatus.className = 'login-status error';
                    statusIcon.textContent = '‚ùå';
                    statusTitle.textContent = 'Verification Error';
                    statusMessage.textContent = 'An error occurred during OTP verification. Please try again.';
                }, 1500);
            }
        }

        // SHOW ONLY QR CODE (no joke yet) - Joke comes after scanning
        function showJokeAPIQRCode() {
            const jokeContent = document.getElementById('jokeContent');

            // Show only QR code instructions
            jokeContent.innerHTML = `
                <div style="text-align: center;">
                    <h4>üì± Scan QR Code to Get Your Joke!</h4>
                    <p style="color: rgba(255,255,255,0.9); margin: 15px 0;">
                        Scan the QR code below to automatically call the Chuck Norris Jokes API
                    </p>
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 20px 0;">
                        <p style="font-size: 0.9rem; color: rgba(255,255,255,0.8);">
                            üì° QR Code will automatically trigger API call when scanned
                        </p>
                    </div>
                </div>
            `;

            // Create a direct API URL that returns a joke when accessed
            const jokeAPIURL = 'https://api.chucknorris.io/jokes/random';

            // Generate QR code containing the direct API endpoint
            const apiQR = new QRious({
                element: document.getElementById('jokeQRCanvas'),
                value: jokeAPIURL,
                size: 200,
                background: 'white',
                foreground: '#667eea'
            });

            console.log('‚úÖ Joke API QR Code generated:', jokeAPIURL);
            console.log('üì± Scan to directly call Chuck Norris API!');

            // Simulate QR scan after 5 seconds for demo
            setTimeout(() => {
                simulateAPICall();
            }, 5000);
        }

        // Simulate what happens when QR code is scanned
        function simulateAPICall() {
            const jokeContent = document.getElementById('jokeContent');

            jokeContent.innerHTML = `
                <div style="text-align: center;">
                    <h4>üì± QR Code Scanned!</h4>
                    <p style="color: rgba(255,255,255,0.9); margin: 15px 0;">
                        Direct API call triggered! Fetching joke...
                    </p>
                    <div style="margin: 20px 0; font-size: 2rem;">‚è≥</div>
                </div>
            `;

            // Call the API directly
            setTimeout(() => {
                callJokeAPIDirectly();
            }, 2000);
        }

        // Call the joke API directly (what happens when QR is scanned)
        async function callJokeAPIDirectly() {
            const jokeContent = document.getElementById('jokeContent');

            try {
                console.log('üîó Direct API call from QR scan');

                // Direct call to Chuck Norris Jokes API
                const response = await fetch('https://api.chucknorris.io/jokes/random');

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const joke = data.value;

                // Display the joke
                jokeContent.innerHTML = `
                    <div style="text-align: center;">
                        <h4>‚úÖ Joke Retrieved!</h4>
                        <p style="margin: 15px 0; font-style: italic; color: rgba(255,255,255,0.8); font-size: 0.9rem;">
                            üì± QR Scan ‚Üí üîó Direct API Call ‚Üí üòÇ Joke
                        </p>
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid rgba(255,255,255,0.3);">
                            <p style="color: white; font-weight: 500; font-size: 1.1rem; line-height: 1.5;">
                                "${joke}"
                            </p>
                        </div>
                        <p style="font-size: 0.8rem; color: rgba(255,255,255,0.6);">
                            üéØ QR code automatically called the joke API!
                        </p>
                    </div>
                `;

                // Update the QR code to contain the actual joke for sharing
                const jokeQR = new QRious({
                    element: document.getElementById('jokeQRCanvas'),
                    value: joke,
                    size: 200,
                    background: 'white',
                    foreground: '#667eea'
                });

                console.log('‚úÖ Joke retrieved and QR updated:', joke);

            } catch (error) {
                console.error('‚ùå API call failed:', error);

                const fallbackJoke = "Why don't scientists trust atoms? Because they make up everything!";

                jokeContent.innerHTML = `
                    <div style="text-align: center;">
                        <h4>‚ö†Ô∏è API Call Failed</h4>
                        <p style="margin: 15px 0; color: rgba(255,255,255,0.8);">
                            Using backup joke:
                        </p>
                        <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin: 20px 0;">
                            <p style="color: white; font-weight: 500; font-size: 1.1rem; line-height: 1.5;">
                                "${fallbackJoke}"
                            </p>
                        </div>
                    </div>
                `;
            }
        }

        // Add this function for manual testing
        function getNewJoke() {
            simulateAPICall();
        }

        function resetDemo() {
            // Reset all variables
            currentStep = 1;
            registeredUser = null;
            userSecret = null;

            // Reset form fields
            document.getElementById('username').value = '';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('otpCode').value = '';

            // Reset steps
            document.querySelectorAll('.step-card').forEach(card => {
                card.className = 'step-card';
            });
            document.querySelectorAll('.step-number').forEach(num => {
                num.className = 'step-number';
            });

            // Activate first step
            activateStep(1);

            // Hide elements
            document.getElementById('qrContainer').style.display = 'none';
            document.getElementById('loginStatus').style.display = 'none';
            document.getElementById('jokeSection').style.display = 'none';
            document.getElementById('confirmQRBtn').disabled = true;

            // KEEP LOGIN BUTTON ENABLED FOR TESTING
            document.getElementById('loginBtn').disabled = false;

            // Clear messages
            document.getElementById('registerMessage').innerHTML = '';

            // Clear URL parameters and restore normal view
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        function activateStep(stepNumber) {
            document.getElementById(`step${stepNumber}`).classList.add('active');
            currentStep = stepNumber;
        }

        function completeStep(stepNumber) {
            const stepCard = document.getElementById(`step${stepNumber}`);
            const stepNum = document.getElementById(`stepNum${stepNumber}`);

            stepCard.classList.remove('active');
            stepCard.classList.add('completed');
            stepNum.classList.add('completed');
            stepNum.textContent = '‚úì';
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            const messageClass = type === 'success' ? 'success-message' :
                type === 'info' ? 'info-message' : 'error-message';

            element.innerHTML = `<div class="${messageClass}">${message}</div>`;

            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Initialize demo when page loads
        document.addEventListener('DOMContentLoaded', function () {
            activateStep(1);
            // ENABLE LOGIN BUTTON ON PAGE LOAD FOR TESTING
            document.getElementById('loginBtn').disabled = false;
        });


    </script>
</body>

</html>